name: front CI/CD Prod

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # build:
  #   runs-on:
  #     - self-hosted
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2
  #       with:
  #         persist-credentials: false

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v2
  #       with:
  #         node-version: "16.x"
  #         always-auth: true

  #     - name: Install dependencies
  #       env:
  #         CI: false
  #       run: |
  #         npm install
  #     - name: Build app
  #       run: |
  #         # npm run build and ignore eslint errors
  #         npm run build -- --max-warnings=200

  buildApk:
    runs-on:
      - self-hosted
    steps:
      - name: Checkout source
        uses: actions/checkout@v2

      - name: Setup java
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Setup Ionic
        uses: coturiv/setup-ionic@v1.0.4

      - name: Install app dependencies
        run: npm install

      - name: Build Ionic App
        run: ionic build

      - name: Copy Android
        run: ionic capacitor copy android

      - name: build release
        uses: sparkfabrik/android-build-action@v1.5.0
        with:
          project-path: android
          output-path: my-app.apk
          ruby-version: "2.7.5"
          bundler-version: "2.3.26"
          fastlane-env: "debug"

      - name: Upload dev APK
        uses: actions/upload-artifact@v1
        with:
          name: app-dev
          path: apk/my-app.apk
